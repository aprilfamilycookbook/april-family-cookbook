let currentUser=null,currentRecipeId=null,currentPendingId=null;async function checkAuth(){try{const e=await fetch("/api/check-auth"),t=await e.json();t.authenticated&&(currentUser=t.name,document.getElementById("loginBtn").style.display="none",document.getElementById("addRecipeBtn").style.display="block",document.getElementById("uploadDocBtn").style.display="block",document.getElementById("pendingBtn").style.display="block",document.getElementById("logoutBtn").style.display="block",document.getElementById("logoutBtn").textContent=`Logout (${t.name})`,updatePendingCount())}catch(e){console.error("Auth check failed:",e)}}function showView(e){document.querySelectorAll(".view").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active"),document.querySelectorAll(".nav-btn").forEach(e=>e.classList.remove("active"))}document.getElementById("homeBtn").addEventListener("click",()=>{showView("homeView"),document.getElementById("homeBtn").classList.add("active"),loadRecipes()}),document.getElementById("loginBtn").addEventListener("click",()=>{showView("loginView"),document.getElementById("loginBtn").classList.add("active")}),document.getElementById("addRecipeBtn").addEventListener("click",()=>{showView("recipeFormView"),document.getElementById("recipeForm").reset(),currentRecipeId=null}),document.getElementById("uploadDocBtn").addEventListener("click",()=>{showView("uploadDocView"),document.getElementById("uploadDocForm").reset(),document.getElementById("uploadStatus").innerHTML=""}),document.getElementById("pendingBtn").addEventListener("click",()=>{showView("pendingView"),loadPendingRecipes()}),document.getElementById("logoutBtn").addEventListener("click",async()=>{await fetch("/api/logout",{method:"POST"}),currentUser=null,document.getElementById("loginBtn").style.display="block",document.getElementById("addRecipeBtn").style.display="none",document.getElementById("uploadDocBtn").style.display="none",document.getElementById("pendingBtn").style.display="none",document.getElementById("logoutBtn").style.display="none",showView("homeView"),document.getElementById("homeBtn").classList.add("active"),loadRecipes()}),document.getElementById("backBtn").addEventListener("click",()=>{showView("homeView"),document.getElementById("homeBtn").classList.add("active"),loadRecipes()}),document.getElementById("cancelFormBtn").addEventListener("click",()=>{showView("homeView"),document.getElementById("homeBtn").classList.add("active")}),document.getElementById("cancelUploadBtn").addEventListener("click",()=>{showView("homeView"),document.getElementById("homeBtn").classList.add("active")}),document.getElementById("backToPendingBtn").addEventListener("click",()=>{showView("pendingView"),loadPendingRecipes()}),document.getElementById("loginForm").addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("username").value,n=document.getElementById("password").value;try{const e=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:n})}),a=await e.json();a.success?(currentUser=a.name,document.getElementById("loginBtn").style.display="none",document.getElementById("addRecipeBtn").style.display="block",document.getElementById("uploadDocBtn").style.display="block",document.getElementById("pendingBtn").style.display="block",document.getElementById("logoutBtn").style.display="block",document.getElementById("logoutBtn").textContent=`Logout (${a.name})`,showView("homeView"),document.getElementById("homeBtn").classList.add("active"),loadRecipes(),updatePendingCount()):document.getElementById("loginError").textContent=a.error||"Login failed"}catch(e){document.getElementById("loginError").textContent="Login failed"}});async function updatePendingCount(){try{const e=await fetch("/api/pending-recipes/count"),t=await e.json();document.getElementById("pendingCount").textContent=t.count}catch(e){console.error("Failed:",e)}}document.getElementById("uploadDocForm").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData,n=document.getElementById("docFile").files[0];if(!n)return void alert("Select a file");t.append("document",n),t.append("title",document.getElementById("docTitle").value),t.append("notes",document.getElementById("docNotes").value);const a=document.getElementById("uploadStatus");a.innerHTML="<p>Uploading...</p>",a.className="upload-status";try{const e=await fetch("/api/upload-document",{method:"POST",body:t}),n=await e.json();n.success?(a.innerHTML="<p>âœ… Uploaded!</p>",a.className="upload-status success",document.getElementById("uploadDocForm").reset(),updatePendingCount(),setTimeout(()=>{showView("homeView"),document.getElementById("homeBtn").classList.add("active")},2e3)):(a.innerHTML=`<p>âŒ ${n.error}</p>`,a.className="upload-status error")}catch(e){a.innerHTML="<p>âŒ Failed</p>",a.className="upload-status error"}});async function loadPendingRecipes(){try{const e=await fetch("/api/pending-recipes"),t=await e.json(),n=document.getElementById("pendingList");0===t.length?n.innerHTML='<p style="text-align:center;color:#888;">No pending recipes</p>':n.innerHTML=t.map(e=>`<div class="pending-item" onclick="processPendingRecipe(${e.id})"><h4>ğŸ“„ ${e.title||e.file_name}</h4><p style="color:#666;">${e.notes||"No notes"}</p><div class="pending-meta"><span>ğŸ‘¤ ${e.submitter_name}</span><span>ğŸ“… ${new Date(e.created_at).toLocaleDateString()}</span><span>ğŸ“ ${e.file_name}</span></div></div>`).join("")}catch(e){console.error("Failed:",e)}}async function processPendingRecipe(e){currentPendingId=e;try{const t=await fetch(`/api/pending-recipes/${e}`),n=await t.json();document.getElementById("extractedTextBox").textContent=n.raw_text,document.getElementById("processTitle").value=n.title||"",showView("processPendingView")}catch(e){console.error("Failed:",e),alert("Failed to load")}}document.getElementById("copyTextBtn").addEventListener("click",()=>{const e=document.getElementById("extractedTextBox").textContent;navigator.clipboard.writeText(e).then(()=>{alert("âœ… Copied!")}).catch(()=>{alert("âŒ Failed")})}),document.getElementById("copyPromptBtn").addEventListener("click",()=>{const e=document.getElementById("extractedTextBox").textContent,t=`Please format this recipe with:\n1. Engaging intro (2-3 sentences)\n2. Ingredients (one per line)\n3. Instructions (one per line)\n4. Prep time, cook time, servings\n5. Category\n\nRecipe text:\n\n${e}`;navigator.clipboard.writeText(t).then(()=>{alert("âœ… Prompt copied!")}).catch(()=>{alert("âŒ Failed")})}),document.getElementById("processRecipeForm").addEventListener("submit",async e=>{e.preventDefault();const t={title:document.getElementById("processTitle").value,description:document.getElementById("processDescription").value,ingredients:document.getElementById("processIngredients").value,instructions:document.getElementById("processInstructions").value,prep_time:document.getElementById("processPrepTime").value||null,cook_time:document.getElementById("processCookTime").value||null,servings:document.getElementById("processServings").value||null,category:document.getElementById("processCategory").value||null};try{const e=await fetch(`/api/pending-recipes/${currentPendingId}/publish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await e.json();n.success?(alert("âœ… Published!"),updatePendingCount(),showView("homeView"),document.getElementById("homeBtn").classList.add("active"),loadRecipes()):alert("âŒ Failed: "+(n.error||"Unknown"))}catch(e){alert("âŒ Failed")}}),document.getElementById("deletePendingBtn").addEventListener("click",async()=>{if(!confirm("Delete?"))return;try{const e=await fetch(`/api/pending-recipes/${currentPendingId}`,{method:"DELETE"}),t=await e.json();t.success?(alert("âœ… Deleted"),updatePendingCount(),showView("pendingView"),loadPendingRecipes()):alert("âŒ Failed")}catch(e){alert("âŒ Failed")}});async function loadRecipes(e="",t=""){try{const n=new URLSearchParams;e&&n.append("search",e),t&&n.append("category",t);const a=await fetch(`/api/recipes?${n}`),d=await a.json(),i=document.getElementById("recipesGrid");0===d.length?i.innerHTML='<p style="text-align:center;color:#888;grid-column:1/-1;">No recipes yet</p>':i.innerHTML=d.map(e=>`<div class="recipe-card" onclick="viewRecipe(${e.id})"><h3>${e.title}</h3><p>${e.description||"No description"}</p><div class="recipe-meta">${e.prep_time?`<span>â±ï¸ ${e.prep_time}min</span>`:""}${e.cook_time?`<span>ğŸ”¥ ${e.cook_time}min</span>`:""}${e.servings?`<span>ğŸ½ï¸ ${e.servings}</span>`:""}</div><div class="recipe-rating">â­ ${e.avgRating.toFixed(1)} (${e.ratingCount})</div><div style="margin-top:0.5rem;color:#888;font-size:0.9rem;">